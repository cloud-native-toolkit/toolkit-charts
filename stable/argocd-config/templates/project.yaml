{{ $globalDestinations := include "argocd.destinations" .Values.global.destinations  }}
{{ $localDestinations := include "argocd.destinations" .Values.applicationTargets  }}
{{/*{{ $destinations := concat $globalDestinations $localDestinations | uniq }}*/}}
{{- if .Values.project }}
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: {{ .Values.project }}
  namespace: {{ .Release.Namespace }}
  labels:
{{ include "argocd.labels" . | indent 4 }}
  annotations:
    helm.sh/hook: pre-install
    argocd.argoproj.io/sync-wave: "-5"
spec:
  sourceRepos:
    - {{ .Values.repoUrl }}
  {{- if .Values.clusterResourceWhitelist }}
  clusterResourceWhitelist:
    {{- .Values.clusterResourceWhitelist | toYaml | nindent 4 }}
  {{- end }}
  {{- if or $globalDestinations $localDestinations }}
  destinations:
  {{- $globalDestinations | nindent 4 -}}
  {{- $localDestinations | nindent 4 -}}
  {{- end }}
{{- end }}
