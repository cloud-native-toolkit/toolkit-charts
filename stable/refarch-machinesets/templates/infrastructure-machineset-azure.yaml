{{- if eq .Values.cloudProvider "azure" }}
{{ $infraid:= required "You need to provide the infrastructureID of your cluster in your values.yaml file" .Values.infrastructureId }}
{{- range .Values.azure.zones }}
---
apiVersion: machine.openshift.io/v1beta1
kind: MachineSet
metadata:
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    helm.sh/hook-weight: "0"
  labels:
    machine.openshift.io/cluster-api-cluster: {{ $.Values.infrastructureId }}
    machine.openshift.io/cluster-api-machine-role: infra
    machine.openshift.io/cluster-api-machine-type: infra
  name: {{ $.Values.infrastructureId }}-infra-{{ $.Values.azure.region }}{{ . }}
  namespace: openshift-machine-api
spec:
  replicas: {{ $.Values.azure.infraNodes.nodeCount }}
  selector:
    matchLabels:
      machine.openshift.io/cluster-api-cluster: {{ $.Values.infrastructureId }}
      machine.openshift.io/cluster-api-machineset: {{ $.Values.infrastructureId }}-infra-{{ $.Values.azure.region }}{{ . }}
  template:
    metadata:
      labels:
        machine.openshift.io/cluster-api-cluster: {{ $.Values.infrastructureId }}
        machine.openshift.io/cluster-api-machine-role: infra
        machine.openshift.io/cluster-api-machine-type: infra
        machine.openshift.io/cluster-api-machineset: {{ $.Values.infrastructureId }}-infra-{{ $.Values.azure.region }}{{ . }}
    spec:
      taints:
      - effect: NoSchedule
        key: infra
        value: reserved
      - effect: NoExecute
        key: infra
        value: reserved
      metadata:
        labels:
          node-role.kubernetes.io/infra: ""
      providerSpec:
        value:
          apiVersion: azureproviderconfig.openshift.io/v1beta1
          credentialsSecret:
            name: azure-cloud-credentials
            namespace: openshift-machine-api
          image:
            offer: ""
            publisher: ""
            resourceID: /resourceGroups/{{ $.Values.infrastructureId }}-rg/providers/Microsoft.Compute/images/{{ $.Values.infrastructureId }}
            sku: ""
            version: ""
          kind: AzureMachineProviderSpec
          location: {{ $.Values.azure.region }}
          managedIdentity: {{ $.Values.infrastructureId }}-identity
          metadata:
            creationTimestamp: null
          networkResourceGroup: {{ $.Values.infrastructureId }}-rg
          osDisk:
            diskSizeGB: {{ $.Values.azure.infraNodes.volumeSize }}
            managedDisk:
              storageAccountType: {{ $.Values.azure.infraNodes.volumeType }}
            osType: Linux
          publicIP: false
          publicLoadBalancer: {{ $.Values.infrastructureId }}
          resourceGroup: {{ $.Values.infrastructureId }}-rg
          subnet: {{ $.Values.infrastructureId }}-worker-subnet
          userDataSecret:
            name: worker-user-data
          vmSize: {{ $.Values.azure.infraNodes.instanceType}}
          vnet: {{ $.Values.infrastructureId }}-vnet
          zone: "{{ . }}"
{{- end }}
{{- end }}
